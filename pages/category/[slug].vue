<template>
  <main class="v-product v-product--list">
    <h1 class="v-hide">{{ title }}</h1>

    <v-container>
      <generalBreadcrumb :items="BreadcrumbItems"/>


      <v-row class="mt-10">
        <v-col cols="12" md="3">
          <generalProductFilterSideBar
              :filterList="productFilterSecondaryData"
              @listFiltersModal="listFiltersModal"
              @selectFiltersModal="selectFiltersModal"
              @switchFiltersModal="switchFiltersModal"
              @setAmount="selectByAmount"/>
        </v-col>
        <v-col cols="12" md="9">
          <div class="v-product__filter d-flex pt-1 align-center justify-space-between">
            <nav class="d-flex align-center flex-grow-1">
              <div class="pl-4">
                <v-icon icon="mdi-sort-ascending" color="grey-darken-1"/>
                <span class="t14 w400 text-grey-darken-1">مرتب‌سازی بر اساس:</span>
              </div>

              <ul class="v-product__filter__items d-flex align-center">
                <li class="t14 w400 text-grey px-4" @click="mostView()">پربازدیدترین</li>
                <li class="t14 w400 text-grey px-4" @click="newest()">جدیدترین</li>
                <li class="t14 w400 text-grey px-4" @click="cheapest()">ارزان‌ترین</li>
                <li class="t14 w400 text-grey px-4" @click="mostExpensive()">گران‌ترین</li>
                <li class="t14 w400 text-grey px-4" @click="biggestDiscount()">بیشترین تخفیف</li>
              </ul>
            </nav>
          </div>

          <div class="v-product__contents mt-6">
            <v-row class="ma-0">
              <v-col
                  cols="12"
                  md="3"
                  v-for="(item, index) in productListData"
                  :key="`card-${index}`"
                  class="v-product__content d-flex">
                <generalProductCard
                    :content="item"
                    class="mb-4 flex-grow-1"
                    :hideInfo="true"
                    :isPLP="true"
                    :showColors="true"/>
              </v-col>
            </v-row>
          </div>

          <div class="v-product__pagination d-flex justify-center mt-8">
            <v-pagination
                v-model="page"
                :length="productListPageLength"
                size="40"
                :total-visible="4"
                prev-icon="mdi-chevron-right"
                next-icon="mdi-chevron-left"/>
          </div>
        </v-col>
      </v-row>
    </v-container>
  </main>
</template>

<script>
import PLP from '@/composables/PLP.js'
import {stringify} from "qs";

export default {
  data() {
    return {
      BreadcrumbItems: [{
        title: 'لوازم آرایشی',
        /* Should be main category */
        href: '/'
      },
        {
          title: 'آرایش صورت',
          /* Should be sub category */
          href: '/products'
        }
      ],
      productList: [],
      filters: [],
    }
  },

  setup(props) {
    const title = ref('فروشگاه اینترنتی شاواز | لیست محصولات فروشگاه شاواز')
    const description = ref(' فروشگاه اینترنتی شاواز، فروشگاه لوازم آرایشی و بهداشتی شاواز ، محصولات آرایشی زنانه، محصولات بهداشتی بانوان* محصولات بهداشتی آقایان،محصولات بهداشتی شخصی')
    const {productList, filterQuery, page, getSecondaryData, secondaryData , filterForFilter , query} = new PLP()
    useHead({
      title,
      meta: [{
        name: 'description',
        content: description
      }]
    });
    return {productList, filterQuery, page, getSecondaryData, secondaryData , filterForFilter , query}
  },

  methods: {
    /**
     * Filter productList by list type items
     * @param {*} array
     */
    listFiltersModal(array) {
      console.log("🚀 ~ listFiltersModal:", array);

      //TODO: Add filter for 'productList'
    },

    /**
     * Filter productList by select type items
     * @param {*} brands
     */
    selectFiltersModal(array) {
      if (array.param === "stock"){
        this.createQueryForFilter(array)
      }
      else{
        const findQueryIndex = this.filterQuery.findIndex(query => query.name === array.name)
        if (findQueryIndex > -1) {
          if (array.values.length) this.filterQuery[findQueryIndex].values = array.values
          else this.filterQuery.splice(findQueryIndex, 1)
        } else {
          this.filterQuery.push(array)
        }
        this.createQueryForFilter()
      }



    },
    /**
     * Filter productList by switch type items
     * @param {*} status
     */
    switchFiltersModal(array) {
      console.log("🚀 ~ switchFiltersModal:", array);
      //TODO: filter by switch items like available
    },

    /**
     * Filter by amount
     * @param {*} amount
     */
   async selectByAmount(amount) {
      console.log(amount.amount?.max)
      if (amount?.param ==="site_price") {
        let site_price_to  = ''
        let site_price_from  = ''
        if (amount.amount?.max){
          site_price_to  =  amount.amount?.max
        }
        if (amount.amount?.min){
          site_price_from  =  amount.amount?.min
        }

        await this.setMinAmount(amount )
        await this.setMaxAmount(amount )




        // else {
        //   if (site_price_from)  this.$router.push(`${this.$route.path}?site_price_from=${site_price_from}`)
        //   if (site_price_to)  this.$router.push(`${this.$route.path}?site_price_to=${site_price_to}`)
        // }
      }
    },
    setMinAmount(amount ){
      let query = this.$route.query;
      if (amount.amount?.min){
        this.$router.push({ query: { ...query,site_price_from: amount.amount?.min } })
      }

    },
    setMaxAmount(amount ){
      let query = this.$route.query;
      if (amount.amount?.max){
        this.$router.push({ query: { ...query,site_price_to: amount.amount?.max } })
      }

    },
    async paramGenerator(array){
      let finalFilterObject =[]
      const newObject = Object.create(this.filterQuery)
      if (array?.param ==="stock") {
        let param  = ''
        if (array.values){
          param  =  `1`
        }
        else {
          param  =  `0`
        }
        let routeSplit = this.$route.fullPath.split('?')
        let query = this.$route.query;
        if (routeSplit[1]){
          if (this.$route.query?.stock){
            if (query){
              this.$router.push({ query: { ...query,stock: param } })
            }
            else {
              this.$router.push({ query: {stock: param } })
            }

          }
          else{
            this.$router.push({ query: {...query, stock: param } })
          }
        }
        else {
          this.$router.push(`${this.$route.path}?stock=${param}`)
        }
      }
      else{
        await  newObject.forEach((query , index)=>{
          query.values.forEach(value=>{
            const form ={
              param:query.param,
              value :value
            }
            finalFilterObject.push (form)
          })
          this.createRoute(finalFilterObject)
        })
      }
    },
    createRoute(values){
      let param = ''
      let brandParam = ''
      let paramQuery =''
      const attributeObject = values.filter(filterValue=> filterValue.param == "attributes")
      const brandObject = values.filter(filterValue=> filterValue.param == "brands")
      attributeObject.forEach(element=>{
        param += `${element.value},`
      })
      brandObject.forEach(element=>{
        brandParam += `${element.value},`
      })

      if (attributeObject.length){
        let finalParam  = `[${param.substring(0, param.length - 1)}]`
        if (!paramQuery) paramQuery += `?attribute=${finalParam}`
        else paramQuery += `&attribute=${finalParam}`
      }
      if (brandObject.length){
        let finalParam  = `[${brandParam.substring(0, brandParam.length - 1)}]`
        if (!paramQuery) paramQuery += `?brands=${finalParam}`
        else paramQuery += `&brands=${finalParam}`
      }
      this.$router.push(this.$route.path + paramQuery)
      const form = {
        ...this.$route.query
      }
      console.log(form)
      this.query = paramQuery
    },
    async createQueryForFilter(array) {
      await this.paramGenerator(array)

    },
  },
  computed: {
    /** return data product list  **/
    productListData() {
      try {
        return this.productList.data.data.data
      } catch (e) {
        return []
      }
    },
    /** return PageLength product list for pagination **/
    productListPageLength() {
      try {
        return this.productList.data.data.last_page
      } catch (e) {
        return 1
      }
    },
    /** return filters on secondaryData slug route **/
    productFilterSecondaryData() {
      try {
        return this.secondaryData.data.data.filters
      } catch (e) {
        return []
      }
    },
  },
  beforeMount() {
    this.getSecondaryData()
  }
}
</script>

<style lang="scss">
@import "~/assets/scss/tools/bp";
@import '~/assets/scss/views/products.scss';
</style>
